name: Sequoia Auto Run

on:
  schedule:
    # 修改为北京时间 01:04 触发 (UTC 17:04)
    - cron: '4 * * * *' 
  workflow_dispatch:

jobs:
  run-strategy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: conda-incubator/setup-miniconda@v2
        with:
          activate-environment: stock
          python-version: "3.12" # 升级版本以支持新库
          channels: conda-forge

      - name: Install Libs
        shell: bash -l {0}
        run: |
          conda install -c conda-forge ta-lib -y
          pip install akshare --upgrade
          pip install -r requirements.txt

      - name: Config Injection
        shell: bash -l {0}
        run: |
          cp config.yaml.example config.yaml
          # 注入所有密钥
          sed -i "s/tushare_token: .*/tushare_token: '${{ secrets.TUSHARE_TOKEN }}'/g" config.yaml
          sed -i "s/pushplus_token: .*/pushplus_token: '${{ secrets.PUSHPLUS_TOKEN }}'/g" config.yaml
          # 单票测试：只看三花智控
          sed -i "s/codes: .*/codes: ['002050.SZ']/g" config.yaml
          mkdir -p data # 防止目录缺失报错

      - name: Run Sequoia
        shell: bash -l {0}
        run: python main.py
