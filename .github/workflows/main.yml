on:
  push:
    branches: [ "master" ]
  workflow_dispatch:  # å¿…é¡»æœ‰è¿™ä¸€è¡Œï¼Œæ‰ä¼šæœ‰æ‰‹åŠ¨è¿è¡ŒæŒ‰é’®
import settings
import work_flow
import akshare as ak
import tushare as ts  # å¼•å…¥ Tushare
import pandas as pd
import time
import requests
import os
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

# 1. é˜²æŠ–è¡¥ä¸
def apply_retry_strategy():
    retry_strategy = Retry(
        total=5, backoff_factor=1,
        status_forcelist=[429, 500, 502, 503, 504],
        allowed_methods=["HEAD", "GET", "OPTIONS", "POST"]
    )
    adapter = HTTPAdapter(max_retries=retry_strategy)
    http = requests.Session()
    http.mount("https://", adapter)
    http.mount("http://", adapter)
    _original_request = requests.Session.request
    def patched_request(self, method, url, *args, **kwargs):
        if 'timeout' not in kwargs: kwargs['timeout'] = 60
        return _original_request(self, method, url, *args, **kwargs)
    requests.Session.request = patched_request

apply_retry_strategy()

# 2. è·å–è‚¡ç¥¨åˆ—è¡¨çš„å‡½æ•° (åŒé€šé“)
def get_all_stock_codes():
    codes = []
    
    # --- é€šé“ A: Akshare (ä¸œæ–¹è´¢å¯Œ) ---
    try:
        print("å°è¯•é€šé“ A (Akshare) æ‹‰å–åå•...")
        df = ak.stock_zh_a_spot_em()
        codes = df['code'].tolist()
        print(f"âœ… é€šé“ A æˆåŠŸï¼è·å–åˆ° {len(codes)} åªè‚¡ç¥¨ã€‚")
    except Exception as e:
        print(f"âš ï¸ é€šé“ A å¤±è´¥: {e}")
    
    # --- é€šé“ B: Tushare (å¤‡ç”¨) ---
    if not codes:
        print("å°è¯•é€šé“ B (Tushare) æ‹‰å–åå•...")
        try:
            # ä»ç¯å¢ƒå˜é‡æˆ–é…ç½®è¯»å– Token
            token = os.environ.get('TS_TOKEN') or settings.config.get('tushare_token')
            if token:
                pro = ts.pro_api(token)
                # è·å–ä¸Šå¸‚çŠ¶æ€ä¸º L (ä¸Šå¸‚) çš„è‚¡ç¥¨
                df = pro.stock_basic(exchange='', list_status='L', fields='symbol')
                codes = df['symbol'].tolist()
                print(f"âœ… é€šé“ B æˆåŠŸï¼è·å–åˆ° {len(codes)} åªè‚¡ç¥¨ã€‚")
            else:
                print("âŒ æœªæ‰¾åˆ° Tushare Tokenï¼Œè·³è¿‡é€šé“ Bã€‚")
        except Exception as e:
            print(f"âš ï¸ é€šé“ B å¤±è´¥: {e}")

    # --- ç»Ÿä¸€è¿‡æ»¤é€»è¾‘ ---
    main_board_codes = []
    for code in codes:
        code = str(code)
        if code.startswith('688'): continue  # å‰”é™¤ç§‘åˆ›
        if code.startswith('30'):  continue  # å‰”é™¤åˆ›ä¸š
        if code.startswith('8') or code.startswith('4'): continue # å‰”é™¤åŒ—äº¤
        
        # æ ¼å¼è¡¥å…¨
        if code.startswith('6'):
            main_board_codes.append(f"{code}.SH")
        else:
            main_board_codes.append(f"{code}.SZ")
            
    return main_board_codes

if __name__ == '__main__':
    settings.init()
    
    print("ğŸš€ æ­£åœ¨æ‹‰å–å…¨å¸‚åœºè‚¡ç¥¨åå•...")
    final_codes = get_all_stock_codes()
    
    if final_codes:
        print(f"âœ… æœ€ç»ˆç­›é€‰å®Œæˆï¼å³å°†æ‰«æ {len(final_codes)} åªä¸»æ¿è‚¡ç¥¨ã€‚")
        settings.config['codes'] = final_codes
    else:
        print("âŒ æ‰€æœ‰é€šé“å‡å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤åˆ—è¡¨ï¼ˆå¦‚æœæ˜¯ç©ºçš„åˆ™ä¸è¿è¡Œï¼‰ã€‚")
        # å…œåº•ï¼šå¦‚æœçœŸçš„å…¨å¤±è´¥äº†ï¼Œå¼ºè¡Œå¡ä¸€ä¸ªä¸‰èŠ±æ™ºæ§è¿›å»æµ‹è¯•ï¼Œé¿å…ç©ºè·‘
        if not settings.config.get('codes'):
            print("âš ï¸ å¯ç”¨ç´§æ€¥å…œåº•ï¼šä»…æµ‹è¯•ä¸‰èŠ±æ™ºæ§")
            settings.config['codes'] = ['002050.SZ']

    work_flow.prepare()
